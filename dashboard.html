<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thrivoy Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header { background: #073378; color: white; padding: 15px; text-align: center; }
    main { padding: 20px; }
    .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card h2 { margin-top: 0; }
    .stats { display: flex; gap: 20px; }
    .stat { flex: 1; background: #f0f4ff; padding: 10px; border-radius: 6px; text-align: center; }
    .btn { display: inline-block; background: #073378; color: white; padding: 10px 15px; margin: 5px 0; border-radius: 6px; text-decoration: none; cursor: pointer; }
    .btn:hover { background: #06285d; }
    iframe { width: 100%; min-height: 300px; border: 1px solid #ccc; border-radius: 6px; }
    #loading { text-align: center; padding: 40px; }
    #error { background: #ffdddd; padding: 10px; margin: 10px 0; border: 1px solid #ff9999; display: none; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <header>
    <h1>Thrivoy Dashboard</h1>
  </header>
  <main>
    <div id="loading">Loading dashboardâ€¦</div>
    <div id="error"></div>

    <div id="dashboard-content" style="display:none;">
      <!-- Business Info -->
      <div class="card">
        <h2 id="business-name">Business Name</h2>
        <p><strong>Owner:</strong> <span id="owner-name"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Phone:</strong> <span id="phone"></span></p>
        <p><strong>Location:</strong> <span id="location"></span></p>
        <p><strong>Category:</strong> <span id="category"></span></p>
        <p><strong>Created:</strong> <span id="created-date"></span></p>
        <p><strong>Last Updated:</strong> <span id="updated-date"></span></p>
      </div>

      <!-- Website -->
      <div class="card">
        <h2>Website</h2>
        <p><a id="website-url" href="#" target="_blank">View Website</a></p>
        <iframe id="website-iframe" src="about:blank"></iframe>
      </div>

      <!-- Stats -->
      <div class="card stats">
        <div class="stat">
          <h3>Total Content</h3>
          <p id="total-content">0</p>
        </div>
        <div class="stat">
          <h3>Published</h3>
          <p id="published-content">0</p>
        </div>
      </div>

      <!-- Content Library -->
      <div class="card">
        <h2>Content Library</h2>
        <ul id="content-library"><li>No content yet</li></ul>
      </div>

      <!-- Actions -->
      <div class="card">
        <h2>Actions</h2>
        <button id="create-payment-btn" class="btn">Create Payment Link</button>
        <button id="share-website-btn" class="btn">Share Website</button>
        <button id="whatsapp-support-btn" class="btn">Contact Support</button>
      </div>

      <!-- Payment QR -->
      <div class="card" id="qr-section" style="display:none;">
        <h2>Payment QR</h2>
        <img id="qr-image" src="" alt="QR Code" style="max-width:200px;display:block;margin:10px auto;">
        <p><a id="upi-link" href="#" target="_blank">Pay Now</a></p>
        <p><strong>Invoice ID:</strong> <span id="invoice-id"></span></p>
      </div>
    </div>
  </main>

  <script>
    // ===== Utility =====
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || null;
    }
    function formatDate(dateStr) {
      if (!dateStr) return "N/A";
      try { return new Date(dateStr).toLocaleDateString(); } catch { return dateStr; }
    }
    function showError(msg) {
      const el = document.getElementById("error");
      el.textContent = msg;
      el.style.display = "block";
    }

    // ===== API Loader =====
    function loadDashboard() {
      const businessId = getQueryParam("businessId") || "BIZ-DEMO";
      const scriptUrl = "https://script.google.com/macros/s/AKfycbwu9uMUiZX1sAJQ7ygUumw3tXwaegk8v9iBkCrSpFdIF8Ua5eICTr6Otq0MJhc6I12smg/exec"; // ðŸ”„ replace with your Apps Script web app URL

      const callbackName = "dashboardCallback_" + Date.now();
      window[callbackName] = function(data) {
        if (!data || data.success === false) {
          showError(data.error || "Failed to load dashboard data");
          return;
        }
        populateDashboard(data);
      };

      const script = document.createElement("script");
      script.src = `${scriptUrl}?action=getDashboard&businessId=${businessId}&callback=${callbackName}`;
      document.body.appendChild(script);
    }

    // ===== Populate Dashboard =====
    function populateDashboard(data) {
      console.log("Dashboard data received:", data);
      const { business, content, websiteUrl } = data;

      document.getElementById("loading").style.display = "none";
      document.getElementById("dashboard-content").style.display = "block";

      // Fill business info
      const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val || "N/A";
      };
      setText("business-name", business.businessName);
      setText("owner-name", business.ownerName);
      setText("email", business.email);
      setText("phone", business.phone);
      setText("location", business.location);
      setText("category", business.category);
      setText("created-date", formatDate(business.createdAt));
      setText("updated-date", formatDate(business.updatedAt));

      // Website
      const websiteLink = document.getElementById("website-url");
      const websiteFrame = document.getElementById("website-iframe");
      if (websiteUrl && websiteUrl.startsWith("http")) {
        websiteLink.href = websiteUrl;
        websiteFrame.src = websiteUrl;
      } else {
        websiteLink.removeAttribute("href");
        websiteFrame.src = "about:blank";
      }

      // Stats
      const posts = Array.isArray(content) ? content : [];
      setText("total-content", posts.length);
      setText("published-content", posts.filter(c => c.status === "published").length);

      // Content library
      populateContentLibrary(posts);

      // Actions
      setupEventListeners(business.businessId, websiteUrl);
    }

    function populateContentLibrary(content) {
      const list = document.getElementById("content-library");
      list.innerHTML = "";
      if (!content || content.length === 0) {
        list.innerHTML = "<li>No content available</li>";
        return;
      }
      content.forEach(post => {
        const li = document.createElement("li");
        li.textContent = `${post.platform.toUpperCase()}: ${post.title}`;
        list.appendChild(li);
      });
    }

    function setupEventListeners(businessId, websiteUrl) {
      const payBtn = document.getElementById("create-payment-btn");
      if (payBtn) {
        payBtn.onclick = () => {
          alert("ðŸ”— Payment link would be generated for " + businessId);
          // Later: call Apps Script to create invoice + QR
        };
      }
      const shareBtn = document.getElementById("share-website-btn");
      if (shareBtn) {
        shareBtn.onclick = () => {
          if (navigator.share) {
            navigator.share({ title: "My Website", url: websiteUrl });
          } else {
            alert("Copy this link to share: " + websiteUrl);
          }
        };
      }
      const supportBtn = document.getElementById("whatsapp-support-btn");
      if (supportBtn) {
        supportBtn.onclick = () => {
          window.open("https://wa.me/917892159170", "_blank"); // ðŸ”„ replace
        };
      }
    }

    // ===== Init =====
    document.addEventListener("DOMContentLoaded", loadDashboard);
  </script>
</body>
</html>
