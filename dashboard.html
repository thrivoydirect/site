<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrivoy Dashboard</title>
  <style>
    /* (same styles as your file ‚Äì unchanged) */
    /* ... keep your full CSS here ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="header fade-in">
      <h1>üöÄ Thrivoy Dashboard</h1>
      <p class="subtitle">Manage your business online presence</p>
    </div>

    <div id="loading" class="loading">
      <div>Loading your dashboard...</div>
      <div style="margin-top: 10px;">‚è≥ Please wait a moment</div>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="dashboard-content" style="display: none;">
      <!-- (all your cards remain exactly the same) -->
      <!-- Business Information, Subscription Status, Website, Content Library, Analytics, Support -->
    </div>
  </div>

  <script>
    const CONFIG = {
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwu9uMUiZX1sAJQ7ygUumw3tXwaegk8v9iBkCrSpFdIF8Ua5eICTr6Otq0MJhc6I12smg/exec',
      SUPPORT_WHATSAPP: '917892159170'
    };

    function getBusinessId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('businessId') || urlParams.get('id') || 'BIZ-1757780208246';
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').innerHTML = `
        <h3>‚ùå Error Loading Dashboard</h3>
        <p>${message}</p>
        <button onclick="location.reload()" class="btn btn-primary">üîÑ Retry</button>
      `;
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    async function loadDashboard() {
      const businessId = getBusinessId();
      if (!businessId) {
        showError('No business ID provided. Please use the correct dashboard link.');
        return;
      }

      try {
        console.log('Loading dashboard for business:', businessId);
        const callbackName = 'dashboardCallback_' + Date.now();
        const script = document.createElement('script');

        // ‚è≥ timeout safeguard
        const timeout = setTimeout(() => {
          showError("Request timed out. Please refresh and try again.");
        }, 10000);

        window[callbackName] = function(data) {
          clearTimeout(timeout);
          document.body.removeChild(script);
          delete window[callbackName];

          if (data && data.success && data.business) {
            populateDashboard(data);
          } else {
            showError(data && data.error ? data.error : 'Invalid response from server');
          }
        };

        script.src = `${CONFIG.API_BASE_URL}?action=getDashboard&businessId=${businessId}&callback=${callbackName}`;
        document.body.appendChild(script);
      } catch (error) {
        console.error('Dashboard loading error:', error);
        showError('Network error. Please check your connection and try again.');
      }
    }

    function populateDashboard(data) {
      console.log('Dashboard data received:', data);
      const { business, content, websiteUrl, trialDaysRemaining, subscriptionActive } = data;

      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';

      // Business info
      document.getElementById('business-name').textContent = business.businessName || 'N/A';
      document.getElementById('owner-name').textContent = business.ownerName || 'N/A';
      document.getElementById('email').textContent = business.email || 'N/A';
      document.getElementById('phone').textContent = business.phone || 'N/A';
      document.getElementById('location').textContent = business.location || 'N/A';
      document.getElementById('category').textContent = business.category || 'N/A';

      // Subscription status (same logic as before)
      // ...

      // Website section with URL validation
      if (websiteUrl && websiteUrl.startsWith("http")) {
        document.getElementById('website-url').href = websiteUrl;
        document.getElementById('website-iframe').src = websiteUrl;
      } else {
        document.getElementById('website-url').removeAttribute('href');
        document.getElementById('website-iframe').src = "about:blank";
      }

      // Content + stats
      populateContentLibrary(content);
      document.getElementById('total-content').textContent = content.length;
      document.getElementById('published-content').textContent = content.filter(c => c.status === 'published').length;
      document.getElementById('created-date').textContent = formatDate(business.createdAt);
      document.getElementById('updated-date').textContent = formatDate(business.updatedAt);

      setupEventListeners(business.businessId, websiteUrl);
    }

    function populateContentLibrary(content) {
      const container = document.getElementById('content-library');
      if (!content || content.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <h4>üìù No content yet</h4>
            <p>Start creating content to grow your online presence!</p>
          </div>
        `;
        return;
      }
      container.innerHTML = content.map(item => `
        <div class="content-item">
          <h4>${item.title || 'Untitled'} <span class="platform-badge">${item.platform}</span></h4>
          <p>${(item.caption || '').substring(0, 100)}${item.caption && item.caption.length > 100 ? '...' : ''}</p>
          <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">
            Created: ${formatDate(item.createdAt)} | Status: ${item.status || 'draft'}
          </p>
        </div>
      `).join('');
    }

    function setupEventListeners(businessId, websiteUrl) {
      document.getElementById('create-payment-btn').addEventListener('click', () => createPaymentInvoice(businessId));
      document.getElementById('share-website-btn').addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({ title: 'Check out my website!', url: websiteUrl });
        } else {
          navigator.clipboard.writeText(websiteUrl).then(() => alert('Website URL copied to clipboard!'));
        }
      });
      const supportBtn = document.getElementById('whatsapp-support-btn');
      const message = `Hi! I need help with my Thrivoy dashboard. Business ID: ${businessId}`;
      supportBtn.href = `https://wa.me/${CONFIG.SUPPORT_WHATSAPP}?text=${encodeURIComponent(message)}`;
    }

    function createPaymentInvoice(businessId) {
      console.log('Creating payment invoice for:', businessId);
      const button = document.getElementById('create-payment-btn');
      const originalText = button.textContent;
      button.textContent = 'Creating Invoice...';
      button.disabled = true;

      const callbackName = 'paymentCallback_' + Date.now();
      const script = document.createElement('script');

      window[callbackName] = function(data) {
        document.body.removeChild(script);
        delete window[callbackName];
        button.textContent = originalText;
        button.disabled = false;

        if (data.success && data.invoice) {
          const invoice = data.invoice;
          document.getElementById('qr-section').style.display = 'block';
          document.getElementById('qr-image').src = invoice.upiQrImage;
          document.getElementById('upi-link').href = invoice.upiDeepLink;
          document.getElementById('invoice-id').textContent = invoice.invoiceId;
          button.style.display = 'none';
          alert('Payment invoice created! Use the QR code or UPI link to complete payment.');
        } else {
          alert('Failed to create payment invoice: ' + (data.error || 'Unknown error'));
        }
      };

      script.src = `${CONFIG.API_BASE_URL}?action=createPayment&businessId=${businessId}&amount=499&callback=${callbackName}`;
      document.body.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Dashboard initializing...');
      loadDashboard();
    });

    setInterval(() => {
      console.log('Auto-refreshing dashboard data...');
      loadDashboard();
    }, 5 * 60 * 1000);
  </script>
</body>
</html>
