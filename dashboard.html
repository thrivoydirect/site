<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrivoy Dashboard</title>
  <style>
    body { font-family: Arial,sans-serif; background:#f0f2f5; margin:0; padding:20px; }
    .container { max-width:1000px; margin:auto; background:white; padding:30px; border-radius:10px; }
    h1 { color:#1166EE; }
    .error { background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; margin-top:20px; display:none; }
    .loading { margin:20px 0; }
    .card { background:#f9f9f9; padding:20px; border-radius:8px; margin-top:20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Thrivoy Dashboard</h1>
    <div class="loading" id="loading">‚è≥ Loading dashboard...</div>
    <div class="error" id="error"></div>
    <div id="dashboard-content" style="display:none;">
      <div class="card">
        <h3>Business Overview</h3>
        <p><b>Name:</b> <span id="bizName"></span></p>
        <p><b>Owner:</b> <span id="owner"></span></p>
        <p><b>Status:</b> <span id="status"></span></p>
      </div>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhVjQXzsl_pgYGBQkmp3GTIhEeEb25AAZfxj-0CwWnuDd_rRj7u2odPMuW7C4R6d3R/exec";

    function jsonpFetch(params) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Date.now();
        window[cbName] = (resp) => { delete window[cbName]; resolve(resp); };
        const s = document.createElement("script");
        params.callback = cbName;
        s.src = APPS_SCRIPT_URL + "?" + new URLSearchParams(params).toString();
        s.onerror = () => reject(new Error("Network error"));
        document.head.appendChild(s);
      });
    }

    async function loadDashboard() {
      const bizId = new URLSearchParams(window.location.search).get("businessId");
      if (!bizId) { 
        document.getElementById("error").innerText = "Missing businessId"; 
        document.getElementById("error").style.display="block"; 
        return; 
      }
      try {
        const resp = await jsonpFetch({ action:"getDashboard", businessId: bizId });
        document.getElementById("loading").style.display="none";
        if (resp && resp.success) {
          document.getElementById("dashboard-content").style.display="block";
          document.getElementById("bizName").innerText = resp.business.businessName;
          document.getElementById("owner").innerText = resp.business.ownerName;
          document.getElementById("status").innerText = resp.business.subscriptionStatus || "Trial";
        } else {
          document.getElementById("error").innerText = resp.error || "Error loading dashboard";
          document.getElementById("error").style.display="block";
        }
      } catch(err) {
        document.getElementById("loading").style.display="none";
        document.getElementById("error").innerText = err.message;
        document.getElementById("error").style.display="block";
      }
    }
    loadDashboard();
  </script>
</body>
</html>
